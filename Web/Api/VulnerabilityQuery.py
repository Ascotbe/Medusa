from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList,MedusaQuery
from ClassCongregation import ScanInformation,ErrorLog
import json
from Web.Workbench.LogRelated import UserOperationLogRecord,RequestLogRecord

"""ActiveScanListQuery
{
	"token": "XXXXX"
}
"""

def ActiveScanListQuery(request):#ä¸»åŠ¨æ‰«æåˆ—è¡¨æŸ¥è¯¢
    RequestLogRecord(request, request_api="active_scan_list_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="active_scan_list_query", uid=Uid)
                ActiveScanListQueryResult=ActiveScanList().Query(uid=Uid)
                if ActiveScanListQueryResult!=None:
                    return JsonResponse({'message':ActiveScanListQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“å‡ºé—®é¢˜äº†ðŸˆ', 'code': 404, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦(>^Ï‰^<)å–µ', 'code': 500, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })



"""ScanInformationQuery
{
	"token": "XXXXX",
	"sid":"1"
}
"""
def ScanInformationQuery(request):#æŸ¥è¯¢å…³ç³»è¡¨
    RequestLogRecord(request, request_api="scan_information_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            Sid=json.loads(request.body)["sid"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="scan_information_query", uid=Uid)
                MedusaQueryResult=ScanInformation().Query(uid=Uid,sid=Sid)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“å‡ºé—®é¢˜äº†ðŸˆ', 'code': 404, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ScanInformationQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦ãƒ½(ï½¥Ï‰ï½¥Â´ï¾’)', 'code': 500, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })

"""MedusaValueQuery
{
	"token": "XXXXX",
	"ssid":"1"
}
"""
def MedusaValueQuery(request):#æŸ¥è¯¢å•ä¸ªæ¼æ´ž
    RequestLogRecord(request, request_api="medusa_value_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            Ssid=json.loads(request.body)["ssid"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="medusa_value_query", uid=Uid)
                MedusaQueryResult=MedusaQuery().Query(uid=Uid,ssid=Ssid)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“å‡ºé—®é¢˜äº†ðŸˆ', 'code': 404, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_MedusaValueQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦ãƒ¾(=ï½¥Ï‰ï½¥=)o', 'code': 500, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })