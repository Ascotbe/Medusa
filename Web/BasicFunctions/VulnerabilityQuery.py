from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList,MedusaQuery
from ClassCongregation import ScanInformation,ErrorLog,PortDB
import json
from Web.Workbench.LogRelated import UserOperationLogRecord,RequestLogRecord

"""active_scan_list_query
{
	"token": "XXXXX"
}
"""

def ActiveScanListQuery(request):#ä¸»åŠ¨æ‰«æåˆ—è¡¨æŸ¥è¯¢
    RequestLogRecord(request, request_api="active_scan_list_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="active_scan_list_query", uid=Uid)
                ActiveScanListQueryResult=ActiveScanList().Query(uid=Uid)
                if ActiveScanListQueryResult!=None:
                    return JsonResponse({'message':ActiveScanListQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“å‡ºé—®é¢˜äº†ðŸˆ', 'code': 404, })
            else:
                return JsonResponse({'message': "å°å®è´è¿™æ˜¯éžæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦(>^Ï‰^<)å–µ', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })



"""scan_information_query
{
	"token": "XXXXX",
	"active_scan_id":"1"
}
"""
def ScanInformationQuery(request):#æŸ¥è¯¢å…³ç³»è¡¨
    RequestLogRecord(request, request_api="scan_information_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ActiveScanId=json.loads(request.body)["active_scan_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="scan_information_query", uid=Uid)
                MedusaQueryResult=ScanInformation().Query(uid=Uid,active_scan_id=ActiveScanId)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“ç‚¸äº†BOOM~ðŸˆ', 'code': 404, })
            else:
                return JsonResponse({'message': "å°å®è´è¿™æ˜¯éžæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ScanInformationQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦ãƒ½(ï½¥Ï‰ï½¥Â´ï¾’)', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })

"""medusa_query
{
	"token": "XXXXX",
	"scan_info_id":"1"
}
"""
def MedusaValueQuery(request):#æŸ¥è¯¢å•ä¸ªæ¼æ´ž
    RequestLogRecord(request, request_api="medusa_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ScanInfoId=json.loads(request.body)["scan_info_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="medusa_query", uid=Uid)
                MedusaQueryResult=MedusaQuery().Query(uid=Uid,scan_info_id=ScanInfoId)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'æ•°æ®åº“GGäº†ðŸˆ', 'code': 404, })
            else:
                return JsonResponse({'message': "å°å®è´è¿™æ˜¯éžæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_MedusaValueQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦ãƒ¾(=ï½¥Ï‰ï½¥=)o', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })

"""actively_scan_port_information
{
	"token": "XXXXX",
	"active_scan_id":"1"
}
"""
def ActivelyScanPortInformation(request):#æŸ¥è¯¢ä¸»åŠ¨æ‰«æä¸­æ‰«æç«¯å£çš„ä¿¡æ¯
    RequestLogRecord(request, request_api="actively_scan_port_information")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ActiveScanId=json.loads(request.body)["active_scan_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # å¦‚æžœç™»å½•æˆåŠŸåŽå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
            if Uid!=None: # æŸ¥åˆ°äº†UID
                UserOperationLogRecord(request, request_api="actively_scan_port_information", uid=Uid)
                PortInformationResult=PortDB().Query(uid=Uid,active_scan_id=ActiveScanId)
                if PortInformationResult!=None:
                    return JsonResponse({'message':PortInformationResult, 'code': 200, })
                else:
                    return JsonResponse({'message': 'å®è´æ²¡æœ‰æ•°æ®å“¦ðŸˆ', 'code': 404, })
            else:
                return JsonResponse({'message': "å˜¿~å®è´è¿™æ˜¯éžæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ScanInformationQuery(def)", e)
            return JsonResponse({'message': 'èŽŽé…±è¢«çŽ©åå•¦ãƒ½(ï½¥Ï‰ï½¥Â´ï¾’)', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })
