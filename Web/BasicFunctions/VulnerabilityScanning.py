import json
from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList
from Web.Workbench.Tasks import MedusaScan
from Web.Workbench.LogRelated import UserOperationLogRecord,RequestLogRecord
from ClassCongregation import ErrorLog,Proxies
from config import headers


#æ¥æ”¶æ•°æ®æ ·å¼
'''vulnerability_scanning
{
	"url": "www.ascotbe.com",
	"token": "1EmWI2bgSWz477WQQMsgWidPSJmUiZy3B4VN0AYczjkdRs5fQvuhwOuek08bVSlzWV1HXf4fWupDgw8m9Lct4frZf5RqYPZBSvrXiIO3uvQ15FRNc8y5f1Rd8Y02CYQLF0BKW0S4qdmVo7k9yOGnpxHpGYfCYXfLi5ZRojsEHhevIEmeECSZL5awSXNWN9EyUQGjndoNoh5EZXxP4wstQA5JILjVldaqcfBElBgWJx4mKeZ9uFE9A4pI3i",
	"process": 200,
	"module": "all",
	"header": "",
	"proxy": "127.0.0.1:8080"
}
'''
##è·å–redisä¸‹å‘ä»»åŠ¡çš„Keyï¼Œç„¶ååå°æŸ¥è¯¢keyæ¥çœ‹æ˜¯å¦å·¥ä½œå®Œæˆï¼Œå®Œæˆçš„è¯å°±æŸ¥Medusaè¡¨ç„¶åå†™å…¥ScanInformationè¡¨,åˆ°æ—¶å€™æ”¾åˆ°Tasksæ–‡ä»¶ä¸­
def Scan(request):
    RequestLogRecord(request, request_api="vulnerability_scanning")
    if request.method == "POST":
        try:
            ReceiveData=json.loads(request.body)
            ScanUrl=ReceiveData["url"]
            ScanToken= ReceiveData["token"]
            ScanModule = ReceiveData["module"]
            ScanProcess = ReceiveData["process"]
            ScanHeader = ReceiveData["header"]
            ScanProxy = ReceiveData["proxy"]
            if ScanProxy is not "":#å¦‚æœä¼ å…¥çš„å€¼ä¸ä¸ºç©º
                ScanProxy=Proxies().result(ScanProxy)

            if ScanHeader == "":  # Headersä¸ºç©ºï¼Œå°±ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å¤´
                ScanHeader = headers

            if type(ScanProcess)==int:#åˆ¤æ–­ç±»å‹
                Uid=UserInfo().QueryUidWithToken(ScanToken)#å¦‚æœç™»å½•æˆåŠŸåå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
                if Uid!=None:
                    UserOperationLogRecord(request, request_api="vulnerability_scanning", uid=Uid)
                    ActiveScanId=ActiveScanList().Write(uid=Uid,url=ScanUrl,proxy=ScanProxy,status=0,module=ScanModule,process=ScanProcess)#å†™å…¥ç”¨æˆ·å…³ç³»è¡¨,ç„¶åè¿”å›sidä¸‹å‘ç»™ä»»åŠ¡
                    RedisActiveScanTask= MedusaScan.delay(ScanUrl,ScanModule,ScanProcess,ScanHeader,ScanProxy,Uid,ActiveScanId)#è°ƒç”¨æ‰«æå¤„ç†å‡½æ•°
                    ActiveScanList().UpdateRedisId(uid=Uid,active_scan_id=ActiveScanId,redis_id=RedisActiveScanTask.task_id)
                    return JsonResponse({'message': 'ä»»åŠ¡ä¸‹å‘æˆåŠŸğŸ‘Œ', 'code': 200, })
                else:
                    return JsonResponse({'message': "å°å®è´è¿™æ˜¯éæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", 'code': 403, })

            else:
                return JsonResponse({'message': 'ç±»å‹é”™è¯¯ï¼', 'code': 666, })

        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': 'èé…±è¢«ç©åæ‰å˜QAQ', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })



def test(request):
    RequestLogRecord(request, request_api="vulnerability_scanning")
    if request.method == "POST":
        try:
            ReceiveData=json.loads(request.body)
            ScanProxy = ReceiveData["proxy"]
            if ScanProxy ==None:
                print("ddddddddddd")
            if ScanProxy is None:
                print("111111")
            print(
                ScanProxy)
            return JsonResponse({'message': [ScanProxy], 'code': 169, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': 'èé…±è¢«ç©åæ‰å˜QAQ', 'code': 169, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })

