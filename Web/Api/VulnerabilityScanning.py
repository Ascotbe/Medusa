import json
from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList
from Web.Workbench.Tasks import MedusaScan
from Web.Workbench.LogRelated import UserOperationLogRecord,RequestLogRecord
from ClassCongregation import ErrorLog


#æ¥æ”¶æ•°æ®æ ·å¼
'''
{
	"url": "www.ascotbe.com",
	"token": "1EmWI2bgSWz477WQQMsgWidPSJmUiZy3B4VN0AYczjkdRs5fQvuhwOuek08bVSlzWV1HXf4fWupDgw8m9Lct4frZf5RqYPZBSvrXiIO3uvQ15FRNc8y5f1Rd8Y02CYQLF0BKW0S4qdmVo7k9yOGnpxHpGYfCYXfLi5ZRojsEHhevIEmeECSZL5awSXNWN9EyUQGjndoNoh5EZXxP4wstQA5JILjVldaqcfBElBgWJx4mKeZ9uFE9A4pI3i",
	"threads": 200,
	"module": "all",
	"header": "None",
	"proxy": "127.0.0.1:8080"
}
'''
##è·å–redisä¸‹å‘ä»»åŠ¡çš„Keyï¼Œç„¶ååå°æŸ¥è¯¢keyæ¥çœ‹æ˜¯å¦å·¥ä½œå®Œæˆï¼Œå®Œæˆçš„è¯å°±æŸ¥Medusaè¡¨ç„¶åå†™å…¥ScanInformationè¡¨,åˆ°æ—¶å€™æ”¾åˆ°Tasksæ–‡ä»¶ä¸­
def Scan(request):
    RequestLogRecord(request, request_api="scan")
    if request.method == "POST":
        try:
            ReceiveData=json.loads(request.body)
            ScanUrl=ReceiveData["url"]
            ScanToken= ReceiveData["token"]
            ScanModule = ReceiveData["module"]
            ScanThreads = ReceiveData["threads"]
            ScanAgentHeader = ReceiveData["header"]
            ScanProxy = ReceiveData["proxy"]
            if ScanProxy==0:#å¦‚æœä¼ å…¥0è¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½
                ScanProxy=None

            if type(ScanThreads)==int:#åˆ¤æ–­ç±»å‹
                TokenQueryReturnValue=UserInfo().QueryTokenValidity(Token=ScanToken)
                if TokenQueryReturnValue:#å¦‚æœTokenå­˜åœ¨
                    Uid=UserInfo().QueryUidWithToken(ScanToken)#å¦‚æœç™»å½•æˆåŠŸåå°±æ¥æŸ¥è¯¢ç”¨æˆ·å
                    if Uid!=None:
                        UserOperationLogRecord(request, request_api="scan", uid=Uid)
                        Sid=ActiveScanList().Write(uid=Uid,url=ScanUrl,proxy=ScanProxy,status=0,module=ScanModule,threads=ScanThreads)#å†™å…¥ç”¨æˆ·å…³ç³»è¡¨,ç„¶åè¿”å›sidä¸‹å‘ç»™ä»»åŠ¡
                        MedusaScan.delay(ScanUrl,ScanModule,ScanThreads,ScanAgentHeader,ScanProxy,Uid=Uid,Sid=Sid)#è°ƒç”¨æ‰«æå¤„ç†å‡½æ•°
                        return JsonResponse({'message': 'ä»»åŠ¡ä¸‹å‘æˆåŠŸğŸ‘Œ', 'code': 200, })
                    else:
                        return JsonResponse({'message': 'è¯¶è¯¶è¯¶è¯¶ï¼Ÿï¼Ÿï¼Ÿæ€ä¹ˆä¼šæŸ¥ä¸åˆ°ç”¨æˆ·åå‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ', 'code': 404, })
                else:
                    return JsonResponse({'message': 'è¯·ç™»å½•è·å–ä»¤ç‰Œç§˜é’¥~', 'code': 404, })
            else:
                return JsonResponse({'message': 'ç±»å‹é”™è¯¯ï¼', 'code': 500, })

        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': 'èé…±åæ‰å•¦ï¼', 'code': 500, })
    else:
        return JsonResponse({'message': 'è¯·ä½¿ç”¨Postè¯·æ±‚', 'code': 500, })

